+++
draft = false
date = "2006-08-23T15:29:14-03:00"
title = "Creating and managing a Windows service (part 1)"
keywords = "Python, cookbook"
created = "2006-08-23T15:17:17-03:00"
modified = "2006-08-23T16:47:48-03:00"
permaLink = "http://play.pixelblaster.ro/blog/archive/2006/08/23/creating-and-managing-a-windows-service"
author = "Tiberiu Ichim"
+++

<p>I'm starting a longer piece on creating and managing a python based Windows service, so look for the other parts in this blog for the complete "recipe"<br /><br />First, our tools: <a href="http://py2exe.org" target="_self">py2exe</a> has, among its deployment targets, a "windows service" option, so we'll need that. To manage the service and interact with the Windows event log, the <a href="http://www.python.net/crew/mhammond/win32/Downloads.html" target="_self">Python win32</a> extension is needed. <br /></p><p>Py2exe has a sample service in the samples/advanced folder, on which I've based my code.</p><pre>import win32serviceutil<br />import win32service<br />import win32event<br />import win32evtlogutil<br />import time, sys, StringIO<br /><br />class MyService(win32serviceutil.ServiceFramework):<br />    _svc_name_ = "MyService"<br />    _svc_display_name_ = "My pretty pretty service"<br />    _svc_deps_ = ["EventLog"]<br />    def __init__(self, args):<br />        win32serviceutil.ServiceFramework.__init__(self, args)<br />        self.hWaitStop = win32event.CreateEvent(None, 0, 0, None)<br /><br />    def SvcStop(self):<br />        self.ReportServiceStatus(win32service.SERVICE_STOP_PENDING)<br />        win32event.SetEvent(self.hWaitStop)<br /><br />    def SvcDoRun(self):<br />        # Write a 'started' event to the event log...<br />        win32evtlogutil.ReportEvent(self._svc_name_,<br />                                    servicemanager.PYS_SERVICE_STARTED,<br />                                    0, # category<br />                                    servicemanager.EVENTLOG_INFORMATION_TYPE,<br />                                    (self._svc_name_, ''))<br /><br />        import servicemanager #another way to write to the event log<br />        servicemanager.LogInfoMsg("Started the service")    #seems to fix the msgids that are logged into the event log<br />                <br />        while True:<br />            # wait for beeing stopped...<br />            rc = win32event.WaitForSingleObject(self.hWaitStop, 1)<br />            if rc==win32event.WAIT_OBJECT_0:<br />                break<br />            time.sleep(2)<br />            servicemanager.LogInfoMsg('next loop')<br /><br />        # and write a 'stopped' event to the event log.<br />        win32evtlogutil.ReportEvent(self._svc_name_,<br />                                    servicemanager.PYS_SERVICE_STOPPED,<br />                                    0, # category<br />                                    servicemanager.EVENTLOG_INFORMATION_TYPE,<br />                                    (self._svc_name_, ''))<br /><br />if __name__ == '__main__':<br />    # Note that this code will not be run in the 'frozen' exe-file!!!<br />    win32serviceutil.HandleCommandLine(MyService)</pre><p>Next, how to create a Windows service from python.<br /></p>

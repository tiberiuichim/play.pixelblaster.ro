+++
draft = false
date = "2007-05-24T17:54:23-03:00"
title = "Using lovely.tag in an edit form (or advanced usage for zope.formlib's EditForm)"
keywords = "zope3, cookbook"
created = "2007-05-24T16:59:57-03:00"
modified = "2007-05-28T13:01:59-03:00"
permaLink = "http://play.pixelblaster.ro/blog/archive/2007/05/24/using-lovely-tag-in-an-edit-form-or-advanced-usage-for-zope-formlib-editform"
author = "Tiberiu Ichim"
+++

<p>lovely.tag is a nice package that has almost all the functionality one can desire from a tagging engine. Recently I needed to integrate it with some of my content types (but not exactly as a tagging widget, but as a global registry for a global vocabulary), so I've created a couple of new widgets (an AJAX based multi-autocomplete one, based on z3c.widget.autocomplete and an add/remove widget, based on Plone's 3rd party AddRemoveWidget). I'll describe here the technique used to integrate the tagging editing in an edit form by using adapters (although this technique is described also in the form.txt from zope.formlib)</p><p>The formlib EditForm class creates a dictionary of adapters that are used for each interface to look up the fields (as attributes to the adapter objects). This translates into the following code (IActivity is a content type item):</p><pre>class IActivity(Interface):<br />    title = TextLine(title=u"Title")<br /><br />class IItemWithTags(Interface):<br />    tags = List(title=u"Tags", value_type=TextLine(title="Tag"))<br /><br />class Activity(Persistent):<br />    implements(IActivity)<br />    title = u""<br /><br />class ActivityEditForm(EditForm):<br />    form_fields = form.Fields(IActivity) + form.Fields(IItemWithTags)<br />    form_fields['tags'].custom_widget = MultiAutoCompleteWidget   #custom built widget<br /></pre><p>Because the IItemWithTags interface is not directly offered by IActivity, there needs to be an adapter that knows how to deal with an Activity in relation with tags.</p><pre>class ActivityTagsEditor(object):<br />    adapts(IActivityItem)<br />    implements(IActivityTags)<br />    uid = None    #the principal id. It is set externally<br />    <br />    def __init__(self, context):<br />        self.context = context<br />        <br />        intids = getUtility(IIntIds)<br />        self.tag_engine = getUtility(ITaggingEngine)<br />        self.oid = intids.getId(self.context)    #the object id<br />        <br />    def _setTags(self, value):<br />        self.tag_engine.update(self.oid, self.uid, value)<br />        <br />    def _getTags(self):<br />        return self.tag_engine.getTags(items=[self.oid]) <br />    <br />    tags = property(_getTags, _setTags)<br /></pre><p>Because of the way the tagging engine works, the adapter needs to know a principal id for whom to set those tags. So we need to overwrite the setUpWidgets method of the form class to set this id on the adapter object (see the setUpEditWidget code to see how the self.adapters registry is filled in).<br /></p><pre>    def setUpWidgets(self, ignore_request=False):<br />        self.adapters = {}<br />        self.widgets = setUpEditWidgets(<br />            self.form_fields, self.prefix, self.context, self.request,<br />            adapters=self.adapters, ignore_request=ignore_request<br />            )<br />        self.adapters[IActivityTags].uid = self.request.principal.id<br /></pre><p>Another way to set up the adapter (if you don't want to mess with setUpWidgets) is something like this in the submit handler, right before the applyChanges call:</p><pre>self.adapters = {IItemsWithTags:getAdapter(self.context, IActivityWithTags)}<br />self.adapters[IItemsWithTags].uid = self.request.principal.id<br />form.applyChanges(self.context, self.form_fields, data, adapters=self.adapters)<br /></pre><p>Reading zope.formlib.form.applyChanges is very educational in order to understand how formlib applies changes to objects and how it builds the self.adapters mapping.<br /></p><p>And finally, the adapter is simply registered with:</p><pre>&lt;zope:adapter factory=".adapters.ActivitityTagsEditor" /&gt;<br /></pre>

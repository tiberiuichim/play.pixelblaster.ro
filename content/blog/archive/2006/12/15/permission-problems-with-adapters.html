+++
draft = false
date = "2006-12-15T18:53:29-02:00"
title = "Permission problems with adapters"
keywords = "zope3, cookbook"
created = "2006-12-15T18:19:24-02:00"
modified = "2006-12-15T18:54:17-02:00"
permaLink = "http://play.pixelblaster.ro/blog/archive/2006/12/15/permission-problems-with-adapters"
author = "Tiberiu Ichim"
+++

<p>Recently I encountered a permission problem that I guess can be tipical when working with adapters based on marker interfaces (such as implementing IRatableItem with a class and adapting it to IRating).</p><p>The code is classic simplistic example of adaptation, using the IAnnotation to store a rating, with the adapter being something along these lines:</p><pre>from interfaces import IRating<br />from zope.annotation.interfaces import IAnnotations<br />from zope.interface import implements<br /><br />class RatingAdapter(object):<br />    implements(IRating)<br /><br />    def __init__(self, context):<br />        self.context=context<br />        self.KEY="ratingAdapter.stage.12_0"<br />        try:<br />            rating=IAnnotations(self.context)[self.KEY]<br />        except KeyError:<br />            IAnnotations(self.context)[self.KEY]=0<br /><br />    def getRating(self):<br />        return IAnnotations(self.context)[self.KEY]<br /><br />    def setRating(self, ratingValue):<br />        IAnnotations(self.context)[self.KEY]=ratingValue<br /><br />    rating = property(getRating, setRating)</pre><p>This class sits in a separate package called "rating". The interfaces for this package:</p><pre>from zope.interface import Interface<br />from zope.schema import Int<br /><br />class IRating(Interface):<br />    """Rating for an item"""<br />    rating = Int(title=u"Rating")<br /><br />    def getRating():<br />        "Returns a rating"<br /><br />    def setRating(value):<br />        "Sets a rating"<br /><br />class IRatable(Interface):<br />    """Marker interface for rating"""<br />    pass</pre><p>The adapter that does the adaption from IRatable to IRating is registered with</p><pre>&lt;adapter<br />        for=".interfaces.IRatable"<br />        provides=".interfaces.IRating"<br />        factory=".ratingadapter.RatingAdapter"<br />        trusted="True"<br />        /&gt;</pre><p>The adapter is set to trusted because it needs access to __annotations__, to be able to store the rating in the annotation. Now all it should needed to do to have ratings on objects is to declare it to implement IRatable and integrate its views with the rating setting methods.</p><p><b>Here comes the problem</b></p><p>I have a content item, let's say IBottle, with an edit form declared like this:</p><pre>class BottleEditForm (EditForm):<br />    form_fields = Fields (IBottle, IRating)</pre><p>The form generation will fail complaining about a forbidden attribute, "rating". Apparently, the adapter class needs to have security declarations as well, with something like this (declared in the rating package):</p><pre>&lt;class class=".ratingadapter.RatingAdapter"&gt;<br />        &lt;require<br />            permission="zope.ManageContent"<br />            set_schema=".interfaces.IRating"<br />            interface=".interfaces.IRating"<br />            /&gt;<br />    &lt;/class&gt;</pre><p>I found traces of this problem mentioned around the web, in these two locations:</p><ul><li><a href="http://zope.org/Collectors/Zope3-dev/438">http://zope.org/Collectors/Zope3-dev/438</a></li><li><a href="http://mail.zope.org/pipermail/zope3-dev/2005-April/014298.html">http://mail.zope.org/pipermail/zope3-dev/2005-April/014298.html</a><br /></li></ul><p><br /></p>
